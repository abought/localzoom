<script>
/* global LocusZoom */
import LzPlot from '@/components/LzPlot.vue';

export default {
    name: 'PhewasMaker',
    beforeCreate() {
        // LZ plots must be stored as static references, not observables
        this.plot = null;
        this.datasources = null;
    },
    props: ['variant_name', 'build', 'your_study', 'your_logpvalue'],
    computed: {
        display_logpvalue() {
            return LocusZoom.TransformationFunctions.get('scinotation')(this.your_logpvalue);
        },
        base_phewas_layout() {
            const layer = LocusZoom.Layouts.get('data_layer', 'phewas_pvalues', {
                unnamespaced: true,
                y_axis: { min_extent: [0, 10] },
            });
            const panel = LocusZoom.Layouts.get('panel', 'phewas', {
                unnamespaced: true,
                data_layers: [layer],
            });

            return LocusZoom.Layouts.get(
                'plot', 'standard_phewas',
                {
                    height: 250,
                    min_height: 200,
                    panels: [panel],
                    state: { variant: this.variant_name, genome_build: this.build },
                },
            );
        },
        base_phewas_sources() {
            return [
                ['phewas', ['PheWASLZ', { url: 'https://portaldev.sph.umich.edu/ukbb/v1/statistic/phewas/' }]],
            ];
        },
    },
    methods: {
        receivePlot(plot, datasources) {
            this.plot = plot;
            this.datasources = datasources;

            // Use listeners to warn when no variant data is available
            plot.subscribeToData(['phewas:id'], (data) => {
                if (!data || !data.length) {
                    plot.curtain.show('There is no PheWAS data available for the requested variant. Please try another variant.');
                }
            });
            // Since the plot already has data, ensure the event fires immediately.
            plot.emit('data_rendered');
        },
    },
    watch: {
        variant_name() {
            // FIXME: Set this up to only re-render when the phewas tab is actually selected. This will improve gwas plot performance and avoid some positioning/rendering issues as screen moves
            if (!this.plot) {
                return;
            }
            this.plot.curtain.hide();
            this.plot.applyState({ variant: this.variant_name });
        },
    },
    components: { LzPlot },
};
</script>

<template>
<div>
  <p v-if="!variant_name">
    Please select a variant in order to generate a PheWAS plot. You can click on any scatter plot
    point in an association track.
  </p>
  <div v-else>
    <h3>{{ variant_name }} in context</h3>
    <p>
      In your study <em style="word-break: break-word">{{ your_study }}</em>, this variant has a
      -log<sub>10</sub> p-value of: <strong>{{ display_logpvalue }}</strong>. Below are other
      results for comparison.
    </p>

    <lz-plot
        :base_layout="base_phewas_layout"
        :base_sources="base_phewas_sources"
        :show_loading="true"

        @connected="receivePlot" />
  </div>
  <p>
    PheWAS results are drawn from a large-scale analysis of the UK Biobank dataset, as described in
    <a href="https://doi.org/10.1038/s41588-018-0184-y">Nature Genetics volume 50, pages 1335â€“1341 (2018)</a>.
  </p>

</div>
</template>


<style scoped>

</style>
